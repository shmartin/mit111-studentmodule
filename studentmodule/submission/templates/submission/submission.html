{% extends 'layout.html' %}

{% block title %}
    Submission
{% endblock %}

{% load static %}

{% block style %}
<link rel="stylesheet" href="{% static 'css/submission.css' %}">
{% endblock %}

{% block content %}
    <header>
        <div class="logo-container">
        <img src="{% static 'images/SAS Logo.png' %}" alt="Institution Logo" class="logo" />
        <div class="institution-name">
          <span>SCHOOL OF ADVANCED STUDIES</span>
          <span class="university-name">Saint Louis University, Baguio City</span>
        </div>
        </div>
        <nav>
           <a href="{% url 'submission' %}">Home</a>
           <a href="{% url 'guidelines' %}">Guidelines</a>
           <a href="{% url 'help' %}">Help</a>
           <a href="{% url 'logout' %}">Logout</a>
        </nav>
    </header>
    <div class="container">

      {% if messages %}
      <ul class="messages">
        {% for message in messages %}
          <li class="{{ message.tags }}">{{ message }}</li>
        {% endfor %}
      </ul>
      {% endif %}

      <div class="notifications">
      <h3>üîî Recent Notifications</h3>
      <ul>
        {% for evaluation in doc_eval %}
          {% if evaluation.status == 'Under Review'%}
            <li>üì¨ <span class="badge under-review">Feedback</span> available for "{{ evaluation.did.dtitle }}"</li>
          {% elif evaluation.status == 'Revision Required' %}
            <li>üì¢ <span class="badge revision">Revisions</span> requested for "{{ evaluation.did.dtitle }}"</li>
          {% elif evaluation.status == 'Accepted' %}
            <li>‚úÖ "{{ evaluation.did.dtitle }}" has been <span class="badge accepted">accepted</span></li>
          {% endif %}
        {% endfor %}
      </ul>
    </div>
    <div class="welcome">
      <h2>üëã Welcome, <span id="studentName">{{ request.user.firstname }} {{ request.user.lastname }}</span>!</h2>
    <form method="POST" enctype="multipart/form-data">
      {% csrf_token %}
      <div class="actions">
        <button type="button">View Submission History</button>
      </div>

      <div class="panel">
        <h3>üìù Submit a New Research Paper</h3>
        <div class="form-group">
          <label for="title">Title:</label>
          <input type="text" id="title" name="dtitle" required>
      </div>
      
      <div class="form-group">
          <label for="adviser">Adviser:</label>
          <input type="text" id="adviser" name="dadviser" required>
      </div>
      <div class="form-group">
        <label for="program">Program/Degree:</label>
        <input type="program" name="program" required>
      </div>
      <div class="form-group">
          <label for="file_path">Upload File (PDF/DOC/DOCX):</label>
          <input type="file" name="file_path" id="file_path" accept=".pdf,.doc,.docx" required>
          <small id="fileError" style="color: red; display: none;">Invalid file. Only PDF, DOC, or DOCX under 20MB allowed.</small>
      </div>

      <button type="submit" class="action-btn">Submit Research Paper</button>
      </div>
    </form>
    <div class="status">
      <h3>üìä My Submissions</h3>
      <table>
        <thead>
          <tr>
            <th>Paper Title</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
    <tbody>
          {% for evaluation in doc_eval %}
            <tr>
              <td>{{ evaluation.did.dtitle }}</td>
              {% if evaluation.status == 'Under Review'%}
                <td><span class="badge under-review">Under Review</span></td>
                {# Removed updated_at display #}
                <td><button class="badge under-review">View</button></td> {# Action button based on status #}
              {% elif evaluation.status == 'Revision Required' %}
                <td><span class="badge revision">Revision Required</span></td>
                {# Removed updated_at display #}
                <td><button class="badge revision">Resubmit</button></td> {# Action button based on status #}
              {% elif evaluation.status == 'Accepted' %}
                <td><span class="badge accepted">Accepted</span></td>
                {# Removed updated_at display #}
                <td><button class="badge accepted">Download</button></td> {# Action button based on status #}
              {% endif %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
<script>
document.getElementById("file_path").addEventListener("change", function () {
    const file = this.files[0];
    const allowedTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
    const maxSize = 20 * 1024 * 1024; // 20MB

    const fileError = document.getElementById("fileError");
    if (file && (!allowedTypes.includes(file.type) || file.size > maxSize)) {
        fileError.style.display = "block";
        this.value = ""; // Reset file input
    } else {
        fileError.style.display = "none";
    }
});
</script>
{% endblock %}
